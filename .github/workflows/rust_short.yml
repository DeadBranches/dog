# GitHub Actions workflow for the *dog* DNS client
# Builds release binaries for the three requested targets only:
#   â€¢ x86_64â€‘pcâ€‘windowsâ€‘msvc
#   â€¢ x86_64â€‘appleâ€‘darwin
#   â€¢ aarch64â€‘unknownâ€‘linuxâ€‘musl
#
# Triggered manually, on any push to `main`, or when a new tag matching `v*` is
# pushed (semanticâ€‘version release tags).

name: BuildÂ &Â Release Binaries

on:
  workflow_dispatch:

# -----------------------------------------------------------------------------
# Global defaults
# -----------------------------------------------------------------------------

defaults:
  run:
    shell: bash

# -----------------------------------------------------------------------------
# Build matrix covering the three required architectures only
# -----------------------------------------------------------------------------

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Windows x86â€‘64 -------------------------------------------------
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive_format: zip
            binary_name: dog.exe
          # --- macOS x86â€‘64 ---------------------------------------------------
          - target: x86_64-apple-darwin
            os: macos-latest
            archive_format: tar.gz
            binary_name: dog
          # --- Linux aarch64 musl --------------------------------------------
          - target: aarch64-unknown-linux-musl
            os: ubuntu-22.04
            archive_format: tar.gz
            binary_name: dog

    steps:
      # -----------------------------------------------------------------------
      # Source checkout
      # -----------------------------------------------------------------------
      - name: ðŸ›Žï¸  Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------------------
      # Rust toolchain installation (stable). We extend the toolchain TOML so
      # `cargo` knows about the extra target.
      # -----------------------------------------------------------------------
      - name: ðŸ¦€  Add target to `rust-toolchain.toml`
        run: |
          echo "targets = ['${{ matrix.target }}']" >> rust-toolchain.toml

      - name: âš™ï¸  Set up Rust toolchain & cache
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache: true

      # -----------------------------------------------------------------------
      # Build the release binary for the current matrix target
      # -----------------------------------------------------------------------
      - name: ðŸ› ï¸  Build release binary
        run: |
          cargo build --release --locked --target ${{ matrix.target }}

      # -----------------------------------------------------------------------
      # Package the binary into an archive suited to the platform
      # -----------------------------------------------------------------------
      - name: ðŸ“¦  Package binary
        shell: bash
        run: |
          BIN_DIR="target/${{ matrix.target }}/release"
          OUT="dog-${{ matrix.target }}.${{ matrix.archive_format }}"
          mkdir package
          cp "$BIN_DIR/${{ matrix.binary_name }}" package/
          if [[ "${{ matrix.archive_format }}" == "zip" ]]; then
            7z a "$OUT" package/* >/dev/null
          else
            tar -C package -caf "$OUT" .
          fi
          echo "ASSET=$OUT" >> $GITHUB_ENV

      # -----------------------------------------------------------------------
      # Upload the archive as a workflow artifact (useful for pullâ€‘request
      # validation runs) *and* attach it to a GitHub Release when the run is
      # triggered from a tag.
      # -----------------------------------------------------------------------
      - name: ðŸ’¾  Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: dog-${{ matrix.target }}
          path: ${{ env.ASSET }}

      - name: ðŸš€  Publish release asset
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2.0.9
        with:
          files: ${{ env.ASSET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
